/*!
 * Copyright 2014-2023 Christoph M. Becker
 *
 * This file is part of Ocal_XH.
 *
 * Ocal_XH is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Ocal_XH is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Ocal_XH.  If not, see <http://www.gnu.org/licenses/>.
 */

 // @ts-check
 
var OCAL = OCAL || {};

(function () {
    "use strict";

    var init, unsavedChanges;

    function warning(event) {
        var confirmation = OCAL.message_unsaved_changes;

        event.returnValue = confirmation;
        return confirmation;
    }

    function makeEditor(element) {
        var occupancy, saveButtons, currentState;

        function onClick(event) {
            var target, state;

            if (typeof currentState !== "number") {
                return;
            }
            target = event.target;
            if (target.classList.contains("ocal_state")) {
                state = +target.dataset.ocal_state;
                if (state !== currentState) {
                    target.setAttribute("data-ocal_state", currentState);
                    element.querySelectorAll(".ocal_statusbar").forEach(function (bar) {
                        bar.innerHTML = "";
                    });
                    addEventListener("beforeunload", warning);
                    unsavedChanges = true;
                }
            }
        }

        function getCalendarStates(calendar) {
            var states, cells;

            states = [];
            cells = calendar.querySelectorAll("td");
            cells.forEach(function (cell) {
                if (cell.classList.contains("ocal_state")) {
                    states.push(cell.dataset.ocal_state);
                }
            });
            return states;
        }

        function getAllCalendarStates() {
            var states, date;

            states = {};
            element.querySelectorAll(".ocal_calendar").forEach(function (calendar) {
                date = calendar.dataset.ocal_date;
                states[date] = getCalendarStates(calendar);
            });
            return states;
        }

        function doReadyStateChange(request) {
            if (request.readyState === 4) {
                element.querySelectorAll(".ocal_loaderbar").forEach(function (bar) {
                    bar.style.display = "none";
                });
                if (request.status === 200) {
                    removeEventListener("beforeunload", warning);
                    unsavedChanges = false;
                    element.querySelectorAll( ".ocal_statusbar").forEach(function (bar) {
                        bar.innerHTML = request.responseText;
                    });
                } else {
                    element.querySelectorAll(".ocal_statusbar").forEach(function (bar) {
                        bar.innerHTML = "<p class=\"xh_fail\">" + request.status + " " + request.statusText + "</p>";
                    });
                }
            }
        }

        function onSelectState(event) {
            var target, elements, cells;

            target = event.target;
            elements = element.querySelectorAll(".ocal_toolbar");
            elements.forEach(function (element) {
                element.querySelectorAll("span").forEach(function (element) {
                    element.style.borderWidth = "";
                });
            });
            currentState = +target.dataset.ocal_state;
            target.style.borderWidth = "3px";
            cells = element.querySelectorAll(".ocal_calendar td.ocal_state");
            cells.forEach(function (cell) {
                cell.style.cursor = "pointer";
            });
        }

        function onSave() {
            var request, tokenInput, payload, states;

            function onReadyStateChange() {
                doReadyStateChange(request);
            }

            request = new XMLHttpRequest();
            request.open(
                "POST",
                location.href.replace(/#.*$/, "") + "&ocal_name=" +
                    occupancy + "&ocal_action=save"
            );
            tokenInput = element.querySelectorAll("input[name=xh_csrf_token]")[0];
            request.setRequestHeader("Content-Type",
                    "application/x-www-form-urlencoded");
            states = JSON.stringify(getAllCalendarStates());
            payload = "ocal_states=" + encodeURIComponent(states) +
                "&xh_csrf_token=" + tokenInput.value;
            request.onreadystatechange = onReadyStateChange;
            request.send(payload);
            element.querySelectorAll(".ocal_loaderbar").forEach(function (bar) {
                bar.style.display = "block";
            });
        }

        occupancy = element.dataset.name;

        element.querySelectorAll(".ocal_calendar").forEach(function (element) {
            element.onclick = onClick;
        });

        element.querySelectorAll(".ocal_toolbar span").forEach(function (element) {
            element.onclick = onSelectState;
        });

        saveButtons = element.querySelectorAll(".ocal_save");
        saveButtons.forEach(function (button) {
            button.onclick = onSave;
            button.disabled = false;
        });
    }

    function onModeOrPaginationClick(event) {
        var target, request, calendar, url;

        if (unsavedChanges) {
            if (window.confirm(OCAL.message_unsaved_changes)) {
                unsavedChanges = false;
                removeEventListener("beforeunload", warning);
            } else {
                return false;
            }
        }
        target = event.target;
        calendar = target.parentNode.parentNode;
        request = new XMLHttpRequest();
        url = target.href + "&ocal_name=" + calendar.dataset.name;
        request.open("GET", url);
        request.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        request.onreadystatechange = function () {
            if (request.readyState === 4) {
                if (request.status === 200) {
                    calendar.outerHTML = request.responseText;
                    init();
                } else {
                    calendar.querySelectorAll(".ocal_loaderbar").forEach(function (bar) {
                        bar.style.display = "none";
                    });
                    calendar.querySelectorAll(".ocal_statusbar").forEach(function (bar) {
                        bar.innerHTML = "<p class=\"xh_fail\">" +
                            request.status + " " + request.statusText + "</p>";
                    });
                }
            }
        };
        request.send(null);
        calendar.querySelectorAll(".ocal_loaderbar").forEach(function (bar) {
            bar.style.display = "block";
        });
        return false;
    }

    init = function () {
        var elements;

        unsavedChanges = false;
        elements = document.querySelectorAll(".ocal_pagination a, .ocal_mode a");
        elements.forEach(function (element) {
            // @ts-ignore
            element.onclick = onModeOrPaginationClick;
        });
        if (OCAL.isAdmin) {
            elements = document.querySelectorAll(".ocal_calendars, .ocal_week_calendars");
            elements.forEach(makeEditor);
        }
    };

    addEventListener("load", init);
}());
